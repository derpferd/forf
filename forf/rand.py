from ctypes import c_ulong, c_long
from typing import Tuple


C_ULONG_8 = c_ulong(8)

# Shim c_ulong to support bit operators.
# https://stackoverflow.com/questions/15570610/ctypes-reimplementation-of-rshift-for-c-ulong
def _rshift(self, other):
    if hasattr(other, 'value'):
        other = other.value
    return c_ulong(self.value >> other)

def _and(self, other):
    if hasattr(other, 'value'):
        other = other.value
    return c_ulong(self.value & other)

def _xor(self, other):
    if hasattr(other, 'value'):
        other = other.value
    return c_ulong(self.value ^ other)

def _mod(self, other):
    if hasattr(other, 'value'):
        other = other.value
    return c_ulong(self.value % other)

def _coerce(self, other):
    try:
        return self, self.__class__(other)
    except TypeError:
        return NotImplemented

c_ulong.__rshift__ = _rshift
c_ulong.__coerce__ = _coerce
c_ulong.__and__ = _and
c_ulong.__xor__ = _xor
c_ulong.__mod__ = _mod


def rand(seed:c_ulong, n:c_ulong) -> Tuple[c_ulong, c_long]:
    lfsr = (seed >> C_ULONG_8) ^ LFSR64_PRECOMP[(seed & 0xff).value]
    return lfsr, c_long((lfsr % n).value)


LFSR64_PRECOMP = [
        0x0000000000000000,
        0xC70000000000000B,
        0x8E0000000000000D,
        0x4900000000000006,
        0x1C00000000000001,
        0xDB0000000000000A,
        0x920000000000000C,
        0x5500000000000007,
        0x3800000000000002,
        0xFF00000000000009,
        0xB60000000000000F,
        0x7100000000000004,
        0x2400000000000003,
        0xE300000000000008,
        0xAA0000000000000E,
        0x6D00000000000005,
        0x7000000000000004,
        0xB70000000000000F,
        0xFE00000000000009,
        0x3900000000000002,
        0x6C00000000000005,
        0xAB0000000000000E,
        0xE200000000000008,
        0x2500000000000003,
        0x4800000000000006,
        0x8F0000000000000D,
        0xC60000000000000B,
        0x0100000000000000,
        0x5400000000000007,
        0x930000000000000C,
        0xDA0000000000000A,
        0x1D00000000000001,
        0xE000000000000008,
        0x2700000000000003,
        0x6E00000000000005,
        0xA90000000000000E,
        0xFC00000000000009,
        0x3B00000000000002,
        0x7200000000000004,
        0xB50000000000000F,
        0xD80000000000000A,
        0x1F00000000000001,
        0x5600000000000007,
        0x910000000000000C,
        0xC40000000000000B,
        0x0300000000000000,
        0x4A00000000000006,
        0x8D0000000000000D,
        0x900000000000000C,
        0x5700000000000007,
        0x1E00000000000001,
        0xD90000000000000A,
        0x8C0000000000000D,
        0x4B00000000000006,
        0x0200000000000000,
        0xC50000000000000B,
        0xA80000000000000E,
        0x6F00000000000005,
        0x2600000000000003,
        0xE100000000000008,
        0xB40000000000000F,
        0x7300000000000004,
        0x3A00000000000002,
        0xFD00000000000009,
        0xC00000000000000B,
        0x0700000000000000,
        0x4E00000000000006,
        0x890000000000000D,
        0xDC0000000000000A,
        0x1B00000000000001,
        0x5200000000000007,
        0x950000000000000C,
        0xF800000000000009,
        0x3F00000000000002,
        0x7600000000000004,
        0xB10000000000000F,
        0xE400000000000008,
        0x2300000000000003,
        0x6A00000000000005,
        0xAD0000000000000E,
        0xB00000000000000F,
        0x7700000000000004,
        0x3E00000000000002,
        0xF900000000000009,
        0xAC0000000000000E,
        0x6B00000000000005,
        0x2200000000000003,
        0xE500000000000008,
        0x880000000000000D,
        0x4F00000000000006,
        0x0600000000000000,
        0xC10000000000000B,
        0x940000000000000C,
        0x5300000000000007,
        0x1A00000000000001,
        0xDD0000000000000A,
        0x2000000000000003,
        0xE700000000000008,
        0xAE0000000000000E,
        0x6900000000000005,
        0x3C00000000000002,
        0xFB00000000000009,
        0xB20000000000000F,
        0x7500000000000004,
        0x1800000000000001,
        0xDF0000000000000A,
        0x960000000000000C,
        0x5100000000000007,
        0x0400000000000000,
        0xC30000000000000B,
        0x8A0000000000000D,
        0x4D00000000000006,
        0x5000000000000007,
        0x970000000000000C,
        0xDE0000000000000A,
        0x1900000000000001,
        0x4C00000000000006,
        0x8B0000000000000D,
        0xC20000000000000B,
        0x0500000000000000,
        0x6800000000000005,
        0xAF0000000000000E,
        0xE600000000000008,
        0x2100000000000003,
        0x7400000000000004,
        0xB30000000000000F,
        0xFA00000000000009,
        0x3D00000000000002,
        0x800000000000000D,
        0x4700000000000006,
        0x0E00000000000000,
        0xC90000000000000B,
        0x9C0000000000000C,
        0x5B00000000000007,
        0x1200000000000001,
        0xD50000000000000A,
        0xB80000000000000F,
        0x7F00000000000004,
        0x3600000000000002,
        0xF100000000000009,
        0xA40000000000000E,
        0x6300000000000005,
        0x2A00000000000003,
        0xED00000000000008,
        0xF000000000000009,
        0x3700000000000002,
        0x7E00000000000004,
        0xB90000000000000F,
        0xEC00000000000008,
        0x2B00000000000003,
        0x6200000000000005,
        0xA50000000000000E,
        0xC80000000000000B,
        0x0F00000000000000,
        0x4600000000000006,
        0x810000000000000D,
        0xD40000000000000A,
        0x1300000000000001,
        0x5A00000000000007,
        0x9D0000000000000C,
        0x6000000000000005,
        0xA70000000000000E,
        0xEE00000000000008,
        0x2900000000000003,
        0x7C00000000000004,
        0xBB0000000000000F,
        0xF200000000000009,
        0x3500000000000002,
        0x5800000000000007,
        0x9F0000000000000C,
        0xD60000000000000A,
        0x1100000000000001,
        0x4400000000000006,
        0x830000000000000D,
        0xCA0000000000000B,
        0x0D00000000000000,
        0x1000000000000001,
        0xD70000000000000A,
        0x9E0000000000000C,
        0x5900000000000007,
        0x0C00000000000000,
        0xCB0000000000000B,
        0x820000000000000D,
        0x4500000000000006,
        0x2800000000000003,
        0xEF00000000000008,
        0xA60000000000000E,
        0x6100000000000005,
        0x3400000000000002,
        0xF300000000000009,
        0xBA0000000000000F,
        0x7D00000000000004,
        0x4000000000000006,
        0x870000000000000D,
        0xCE0000000000000B,
        0x0900000000000000,
        0x5C00000000000007,
        0x9B0000000000000C,
        0xD20000000000000A,
        0x1500000000000001,
        0x7800000000000004,
        0xBF0000000000000F,
        0xF600000000000009,
        0x3100000000000002,
        0x6400000000000005,
        0xA30000000000000E,
        0xEA00000000000008,
        0x2D00000000000003,
        0x3000000000000002,
        0xF700000000000009,
        0xBE0000000000000F,
        0x7900000000000004,
        0x2C00000000000003,
        0xEB00000000000008,
        0xA20000000000000E,
        0x6500000000000005,
        0x0800000000000000,
        0xCF0000000000000B,
        0x860000000000000D,
        0x4100000000000006,
        0x1400000000000001,
        0xD30000000000000A,
        0x9A0000000000000C,
        0x5D00000000000007,
        0xA00000000000000E,
        0x6700000000000005,
        0x2E00000000000003,
        0xE900000000000008,
        0xBC0000000000000F,
        0x7B00000000000004,
        0x3200000000000002,
        0xF500000000000009,
        0x980000000000000C,
        0x5F00000000000007,
        0x1600000000000001,
        0xD10000000000000A,
        0x840000000000000D,
        0x4300000000000006,
        0x0A00000000000000,
        0xCD0000000000000B,
        0xD00000000000000A,
        0x1700000000000001,
        0x5E00000000000007,
        0x990000000000000C,
        0xCC0000000000000B,
        0x0B00000000000000,
        0x4200000000000006,
        0x850000000000000D,
        0xE800000000000008,
        0x2F00000000000003,
        0x6600000000000005,
        0xA10000000000000E,
        0xF400000000000009,
        0x3300000000000002,
        0x7A00000000000004,
        0xBD0000000000000F,
    ]